
var prev_caret_position=-1;(function($){function getRetypeStyledHtml(options){var construct="";construct=construct+('<div class="retype-container">');construct=construct+('<div class="retype-div">');construct=construct+('<div class="retype-textarea">');construct=construct+('<textarea id="'+options.id+'" rows="10" cols="50" scrolltop="scrollHeight"></textarea>');construct=construct+('</div>');construct=construct+('<div class="retype-options">');for(var i=0;i<options.language.length;i++){var languageId='retype-language-'+options.language[i].name;var languageName=options.language[i].name;var languageDisplayName=languageName;if(options.language[i].displayName){languageDisplayName=options.language[i].displayName;}
construct=construct+('<li class="retype-option">');construct=construct+('<a href="#'+languageName+'" id="'+languageId+'">'+languageDisplayName+'</a>');construct=construct+('</li>');}
construct=construct+('<li class="retype-option-keyboard"><a href="#">Keyboard</a></li>');construct=construct+('</div><!-- options -->');construct=construct+('<div class="retype-help"></div>');construct=construct+('</div><!-- div --></div><!-- container -->');return construct;}
$.fn.retypeStyled=function(mode,options){mode=mode||'on';return this.each(function(){$this=$(this);var number_of_retype_containers_in_dom=$(".retype-container").size();var unique_id="retype-container-no-"+number_of_retype_containers_in_dom;var construct=getRetypeStyledHtml(options);$this.append(construct);$(this).children(".retype-container").attr('id',unique_id);$("#"+unique_id+" .retype-option").each(function(intIndex){$(this).bind("click",function(e){$("#"+unique_id+" *").removeClass("retype-option-selected");$("#"+unique_id+" #retype-language-"+options.language[intIndex].name).addClass("retype-option-selected");$("#"+options.id).retype("off");$("#"+options.id).retype("on",options.language[intIndex]);$("#"+unique_id+" .retype-help").hide();if(options.language[intIndex].help){$("#"+unique_id+" .retype-help").html("<p>"+options.language[intIndex].help+"</p>");}
if(options.language[intIndex].help_url){$("#"+unique_id+" .retype-help").load(options.language[intIndex].help_url);}
$("#"+unique_id+" .retype-help").fadeIn("fast");$("#"+options.id).focus();});});$("#retype-language-"+options.language[0].name).addClass("retype-option-selected");$("#"+options.id).retype("off");$("#"+options.id).retype("on",options.language[0]);if(options.language[0].help){$("#"+unique_id+" .retype-help").html("<p>"+options.language[0].help+"</p>");}
if(options.language[0].help_url){$("#"+unique_id+" .retype-help").load(options.language[0].help_url);}
$("#"+options.id).focus();});};$.fn.retype=function(mode,options){mode=mode||'on';options=$.extend({},$.fn.retype.options,options);if(options.mapping_url){$.get(options.mapping_url,function(data){eval("options.mapping = "+data);});}
return this.each(function(){$this=$(this);if(mode=="on"||mode=="enable"){$this.keydown(handle_echoid);$this.keydown(handle_escape);$this.keypress(handle_alpha);if(options.name!='Dvorak'){$this.keyup(handle_composite);}
$this.keydown(retype_debug).keypress(retype_debug);}else{$this.unbind("keydown");$this.unbind("keyup");$this.unbind("keypress");}
function retype_debug(e){$("#retype-debug").html("clientHeight: "+$("#"+options.id).attr("clientHeight")+"\n"+"scrollHeight: "+$("#"+options.id).attr("scrollHeight")+"\n"+"KeyCode: "+e.charCode+"\n"+"Alt: "+e.altKey+"\n"+"Meta: "+e.metaKey+"\n"+"Shift: "+e.shiftKey+"\n"+"Ctrl: "+e.ctrlKey+"\n");}
function handle_escape(e){if(e.keyCode==27){var scrollTop=this.scrollTop;var range=$(this).getSelection();var current=this.value;var prefix=current.substring(0,range.start);var suffix=current.substring(range.start,current.length);var caret_position=range.start;var the_new_current="";var replacement_length=1;if(e.shiftKey){if(options.mapping["shift-escape"]){replacement_length=options.mapping["shift-escape"].length;the_new_current=prefix+options.mapping["shift-escape"]+suffix;}else{return;}}else{if(options.mapping["escape"]){replacement_length=options.mapping["escape"].length;the_new_current=prefix+options.mapping["escape"]+suffix;}else{return;}}
this.value=the_new_current;this.setSelectionRange(caret_position+replacement_length,caret_position+replacement_length);this.scrollTop=scrollTop;return false;}}
function handle_composite(e){var scrollTop=this.scrollTop;var range=$(this).getSelection();var current=this.value;var prefix=current.substring(0,range.start);var suffix=current.substring(range.start,current.length);var caret_position=range.start;var the_new_current="";var last_typed=current.substring(range.start-1,range.start);if(last_typed=='\u00E4'||last_typed=='\u00F6'||last_typed=='\u00FC'||last_typed=='\u00C4'||last_typed=='\u00D6'||last_typed=='\u00DC'||last_typed=='<'||last_typed=='>'){prefix=current.substring(0,range.start-1);if(options.mapping[last_typed]){var replacement_length=options.mapping[last_typed].length;var the_new_current=prefix+options.mapping[last_typed]+suffix;this.value=the_new_current;this.setSelectionRange(caret_position+replacement_length,caret_position+replacement_length);this.scrollTop=scrollTop;return false;}else{return;}}
this.scrollTop=scrollTop;return false;}
function handle_echoid(e){var scrollTop=this.scrollTop;var range=$(this).getSelection();var current=this.value;var prefix=current.substring(0,range.start);var suffix=current.substring(range.start,current.length);var caret_position=range.start;if(e.altKey){var the_key_string=null;if(e.shiftKey){the_key_string="shift+alt+"+String.fromCharCode(e.keyCode);}else{the_key_string="alt+"+String.fromCharCode(e.keyCode);}
if(options.mapping[the_key_string]){var the_new_current=prefix+options.mapping[the_key_string]+suffix;this.value=the_new_current;this.setSelectionRange(caret_position+1,caret_position+1);this.scrollTop=scrollTop;return false;}}}
function handle_alpha(e){var returnval=true;var caret_position;var scrollTop=this.scrollTop;if(!e.ctrlKey&&!e.altKey&&!e.metaKey){var range=$(this).getSelection();caret_position=range.start;var current=this.value;var the_key_string=String.fromCharCode(e.charCode);if(prev_caret_position+1==caret_position){var prevKey=current.substring(prev_caret_position,caret_position);if(options.mapping[prevKey+the_key_string]){the_key_string=prevKey+the_key_string;--caret_position;}}
if(options.mapping[the_key_string]){var range=$(this).getSelection();var current=this.value;var prefix=current.substring(0,caret_position);var suffix=current.substring(range.start,current.length);var replacement_length=options.mapping[the_key_string].length;var the_new_current=prefix+options.mapping[the_key_string]+suffix;this.value=the_new_current;if(caret_position==-1){caret_position+=1;}
this.setSelectionRange(caret_position+replacement_length,caret_position+replacement_length);returnval=false;}else{}
this.scrollTop=scrollTop;prev_caret_position=caret_position;return returnval;}}});};})(jQuery);